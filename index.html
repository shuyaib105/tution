<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>স্টুডেন্ট ম্যানেজমেন্ট সিস্টেম</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --card-bg: #ffffff;
            --body-bg: #f5f7ff;
            --border-color: #e0e0e0;
            --text-color: #333333;
            --text-light: #6c757d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .form-card {
            max-width: 600px;
            margin: 0 auto 30px;
        }
        
        /* Tabs */
        .section-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            background: var(--card-bg);
            border-radius: 8px 8px 0 0;
            padding: 0 15px;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        
        /* Tab Content */
        .section-content {
            display: none;
            animation: fadeIn 0.3s ease;
            background: var(--card-bg);
            border-radius: 0 0 8px 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Hind Siliguri', sans-serif;
            transition: border 0.3s ease;
            background-color: var(--light-color);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Hind Siliguri', sans-serif;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #3ab4d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 201, 240, 0.3);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e07c0e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(248, 150, 30, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #e51778;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(247, 37, 133, 0.3);
        }
        
        /* Scrollable Tables */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--light-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            color: var(--primary-color);
        }
        
        tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: var(--light-color);
            padding: 15px;
            border-radius: 8px;
        }
        
        .progress-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 10px;
            margin-right: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.6s ease;
            border-radius: 10px;
        }
        
        .completed {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .payment-record {
            color: var(--warning-color);
            font-weight: 500;
        }
        
        .attendance-record {
            color: var(--primary-color);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        input[type="checkbox"] {
            width: auto;
            transform: scale(1.5);
            accent-color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            background: var(--light-color);
            color: var(--text-color);
        }
        
        .badge-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background: var(--warning-color);
            color: white;
        }
        
        @media (max-width: 768px) {
            .section-tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: left;
                padding: 12px 20px;
            }
            
            th, td {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Firebase Auth UI Styles */
        #auth-container {
            text-align: center;
            margin: 20px 0;
        }

        #user-info {
            display: none;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        #user-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        #user-name {
            font-weight: 600;
            margin-right: 15px;
        }

        /* Cycle History Styles */
        .cycle-card {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .cycle-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .cycle-dates {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .cycle-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.2em;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-light);
        }

        .teaching-dates {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .teaching-date-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .teaching-date-item:last-child {
            border-bottom: none;
        }

        .toggle-dates {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
            display: inline-block;
        }

        .toggle-dates:hover {
            text-decoration: underline;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Firebase Auth UI -->
        <div id="auth-container">
            <div id="user-info">
                <img id="user-pic" src="">
                <span id="user-name"></span>
                <button onclick="firebase.auth().signOut()" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> লগআউট
                </button>
            </div>
            <button id="google-login-btn" class="btn-primary">
                <i class="fab fa-google"></i> গুগল দিয়ে লগইন
            </button>
        </div>

        <h1><i class="fas fa-user-graduate"></i> স্টুডেন্ট ম্যানেজমেন্ট সিস্টেম</h1>
        
        <div id="success-alert" class="alert alert-success"></div>
        <div id="error-alert" class="alert alert-danger"></div>
        
        <!-- Section Tabs -->
        <div class="section-tabs">
            <button class="tab active" data-section="registration"><i class="fas fa-user-plus"></i> রেজিস্ট্রেশন</button>
            <button class="tab" data-section="attendance"><i class="fas fa-calendar-check"></i> পড়ানো/বেতন</button>
            <button class="tab" data-section="records"><i class="fas fa-database"></i> সমস্ত রেকর্ড</button>
            <button class="tab" data-section="history"><i class="fas fa-history"></i> সাইকেল ইতিহাস</button>
        </div>
        
        <!-- Registration Section -->
        <div class="section-content active" id="registration">
            <div class="card form-card">
                <h2><i class="fas fa-user-edit"></i> স্টুডেন্ট রেজিস্ট্রেশন</h2>
                <form id="student-form">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user"></i> স্টুডেন্টের নাম</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone"><i class="fas fa-phone"></i> ফোন নম্বর</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label for="section"><i class="fas fa-users"></i> সেকশন</label>
                        <select id="section" required>
                            <option value="">সিলেক্ট করুন</option>
                            <option value="A">শনি - সোম - বুধ</option>
                            <option value="B">রবি - মঙ্গল - বৃহস্পতি</option>
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn-primary"><i class="fas fa-save"></i> রেজিস্টার করুন</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> সকল স্টুডেন্ট</h2>
                    <span class="badge badge-primary">মোট: <span id="total-students">0</span></span>
                </div>
                <div class="table-container">
                    <table id="all-students-list">
                        <thead>
                            <tr>
                                <th>সেকশন</th>
                                <th>নাম</th>
                                <th>ফোন</th>
                                <th>মোট ক্লাস</th>
                                <th>বেতন</th>
                                <th>অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- All students will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Attendance Section -->
        <div class="section-content" id="attendance">
            <div class="card">
                <h2><i class="fas fa-calendar-alt"></i> পড়ানো ও বেতন ম্যানেজমেন্ট</h2>
                <div class="form-group">
                    <label for="record-date"><i class="fas fa-calendar-day"></i> তারিখ</label>
                    <input type="date" id="record-date" required>
                </div>
                
                <div class="table-container">
                    <h3><i class="fas fa-users"></i> শনি - সোম - বুধ</h3>
                    <table id="attendance-list-a">
                        <thead>
                            <tr>
                                <th>নাম</th>
                                <th>ফোন</th>
                                <th>মোট ক্লাস</th>
                                <th class="checkbox-cell">পড়িয়েছি</th>
                                <th class="checkbox-cell">বেতন</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Section A attendance will be listed here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="table-container">
                    <h3><i class="fas fa-users"></i> রবি - মঙ্গল - বৃহস্পতি</h3>
                    <table id="attendance-list-b">
                        <thead>
                            <tr>
                                <th>নাম</th>
                                <th>ফোন</th>
                                <th>মোট ক্লাস</th>
                                <th class="checkbox-cell">পড়িয়েছি</th>
                                <th class="checkbox-cell">বেতন</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Section B attendance will be listed here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button id="save-records" class="btn-success"><i class="fas fa-save"></i> সেভ করুন</button>
                    <button id="reset-records" class="btn-warning"><i class="fas fa-undo"></i> রিসেট করুন</button>
                </div>
            </div>
        </div>
        
        <!-- Records Section -->
        <div class="section-content" id="records">
            <div class="card">
                <h2><i class="fas fa-archive"></i> সমস্ত রেকর্ডস</h2>
                
                <div class="form-group">
                    <label for="student-select"><i class="fas fa-user"></i> স্টুডেন্ট সিলেক্ট করুন</label>
                    <select id="student-select">
                        <option value="">সিলেক্ট করুন</option>
                    </select>
                </div>
                
                <div id="student-records-container" style="display:none;">
                    <h3 id="student-name-display"></h3>
                    
                    <div class="progress-container">
                        <span><i class="fas fa-chart-line"></i> প্রোগ্রেস:</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <span id="progress-text" style="margin-left: 10px;"></span>
                    </div>
                    
                    <div class="table-container">
                        <h4><i class="fas fa-chalkboard-teacher"></i> পড়ানোর রেকর্ড</h4>
                        <table id="teaching-records">
                            <thead>
                                <tr>
                                    <th>তারিখ</th>
                                    <th>স্ট্যাটাস</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Teaching records will be listed here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-container">
                        <h4><i class="fas fa-money-bill-wave"></i> বেতনের রেকর্ড</h4>
                        <table id="payment-records">
                            <thead>
                                <tr>
                                    <th>তারিখ</th>
                                    <th>স্ট্যাটাস</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Payment records will be listed here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="delete-student" class="btn-danger"><i class="fas fa-trash-alt"></i> স্টুডেন্ট ডিলেট করুন</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cycle History Section -->
        <div class="section-content" id="history">
            <div class="card">
                <h2><i class="fas fa-history"></i> সাইকেল ইতিহাস</h2>
                
                <div class="form-group">
                    <label for="history-student-select"><i class="fas fa-user"></i> স্টুডেন্ট সিলেক্ট করুন</label>
                    <select id="history-student-select">
                        <option value="">সিলেক্ট করুন</option>
                    </select>
                </div>
                
                <div id="cycle-history-container" style="display:none;">
                    <h3 id="history-student-name"></h3>
                    
                    <div id="cycle-history-list">
                        <!-- Cycle history cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEe2ayxZevgU9-Nvv8HiD2mYLsdvQyJ2k",
            authDomain: "student-managment-system-a9c4e.firebaseapp.com",
            databaseURL: "https://student-managment-system-a9c4e-default-rtdb.firebaseio.com",
            projectId: "student-managment-system-a9c4e",
            storageBucket: "student-managment-system-a9c4e.appspot.com",
            messagingSenderId: "521962782265",
            appId: "1:521962782265:web:c2458650f72353cfee57e8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Firebase services
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let students = [];
        let teachingRecords = [];
        let paymentRecords = [];
        
        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
            
            // Initialize authentication
            initAuth();
            
            // Initialize tabs
            initTabs();
            
            // Initialize forms
            initForms();
            
            // Initialize save records button
            document.getElementById('save-records').addEventListener('click', saveRecords);
            
            // Initialize reset records button
            document.getElementById('reset-records').addEventListener('click', resetRecords);
            
            // Initialize student dropdown for records
            document.getElementById('student-select').addEventListener('change', loadStudentRecords);
            
            // Initialize delete student button
            document.getElementById('delete-student').addEventListener('click', deleteSelectedStudent);
            
            // Initialize history student dropdown
            document.getElementById('history-student-select').addEventListener('change', loadCycleHistory);
        });
        
        // Authentication functions
        function initAuth() {
            // Google login button
            document.getElementById('google-login-btn').addEventListener('click', googleSignIn);
            
            // Auth state listener
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    showUserInfo(user);
                    document.getElementById('google-login-btn').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    
                    // Show app content
                    document.querySelectorAll('.tab').forEach(el => el.style.display = 'block');
                    document.querySelector('.tab.active').click();
                    
                    // Load data for this user
                    loadData();
                } else {
                    // User is signed out
                    document.getElementById('google-login-btn').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                    
                    // Hide all app content
                    document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.tab').forEach(el => el.style.display = 'none');
                }
            });
        }
        
        function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(() => {
                    showAlert('success', 'সফলভাবে লগইন করা হয়েছে!');
                })
                .catch((error) => {
                    showAlert('error', `লগইন ব্যর্থ: ${error.message}`);
                });
        }
        
        function showUserInfo(user) {
            document.getElementById('user-name').textContent = user.displayName || user.email;
            document.getElementById('user-pic').src = user.photoURL || 'https://via.placeholder.com/40';
        }
        
        // Load data from Firebase
        function loadData() {
            const userId = auth.currentUser.uid;
            if (!userId) return;
            
            // Load students
            database.ref('users/' + userId + '/students').on('value', (snapshot) => {
                students = [];
                snapshot.forEach((childSnapshot) => {
                    students.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                loadStudentLists();
                updateStudentDropdowns();
            });
            
            // Load teaching records
            database.ref('users/' + userId + '/teachingRecords').on('value', (snapshot) => {
                teachingRecords = [];
                snapshot.forEach((childSnapshot) => {
                    teachingRecords.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                // Refresh attendance lists if attendance tab is active
                if (document.getElementById('attendance').classList.contains('active')) {
                    loadAttendanceLists();
                }
            });
            
            // Load payment records
            database.ref('users/' + userId + '/paymentRecords').on('value', (snapshot) => {
                paymentRecords = [];
                snapshot.forEach((childSnapshot) => {
                    paymentRecords.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                // Refresh records if records tab is active
                if (document.getElementById('records').classList.contains('active')) {
                    const selectedStudent = document.getElementById('student-select').value;
                    if (selectedStudent) loadStudentRecords();
                }
                // Refresh history if history tab is active
                if (document.getElementById('history').classList.contains('active')) {
                    const selectedStudent = document.getElementById('history-student-select').value;
                    if (selectedStudent) loadCycleHistory();
                }
            });
        }
        
        // Tab functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load appropriate data based on tab
                    switch(sectionId) {
                        case 'attendance':
                            loadAttendanceLists();
                            break;
                        case 'records':
                            updateStudentDropdowns();
                            break;
                        case 'history':
                            updateStudentDropdowns();
                            break;
                    }
                });
            });
        }
        
        // Form functionality
        function initForms() {
            // Student registration form
            document.getElementById('student-form').addEventListener('submit', function(e) {
                e.preventDefault();
                registerStudent();
            });
        }
        
        // Show alert message
        function showAlert(type, message) {
            const alertElement = type === 'success' 
                ? document.getElementById('success-alert')
                : document.getElementById('error-alert');
            
            alertElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            alertElement.style.display = 'block';
            
            // Hide other alert
            if (type === 'success') {
                document.getElementById('error-alert').style.display = 'none';
            } else {
                document.getElementById('success-alert').style.display = 'none';
            }
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 3000);
        }
        
        // Register a new student
        function registerStudent() {
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const sectionInput = document.getElementById('section');
            
            // Validate inputs
            if (!nameInput.value.trim()) {
                showAlert('error', 'দয়া করে স্টুডেন্টের নাম লিখুন');
                return;
            }
            
            if (!sectionInput.value) {
                showAlert('error', 'দয়া করে সেকশন সিলেক্ট করুন');
                return;
            }
            
            const newStudent = {
                name: nameInput.value.trim(),
                phone: phoneInput.value.trim(),
                section: sectionInput.value,
                currentCycleStart: new Date().toISOString().split('T')[0],
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            const userId = auth.currentUser.uid;
            const newStudentRef = database.ref('users/' + userId + '/students').push();
            newStudent.id = newStudentRef.key;
            newStudentRef.set(newStudent)
                .then(() => {
                    // Reset form
                    nameInput.value = '';
                    phoneInput.value = '';
                    sectionInput.value = '';
                    
                    showAlert('success', `${newStudent.name} সফলভাবে রেজিস্টার্ড হয়েছে!`);
                })
                .catch(error => {
                    showAlert('error', `স্টুডেন্ট সেভ করতে সমস্যা: ${error.message}`);
                });
        }
        
        // Load all student lists
        function loadStudentLists() {
            // Update total students count
            document.getElementById('total-students').textContent = students.length;
            
            // Load all students list
            renderAllStudentsList('all-students-list', students);
        }
        
        // Load attendance lists
        function loadAttendanceLists() {
            // Load section A students
            const sectionAStudents = students.filter(student => student.section === 'A');
            renderAttendanceList('attendance-list-a', sectionAStudents);
            
            // Load section B students
            const sectionBStudents = students.filter(student => student.section === 'B');
            renderAttendanceList('attendance-list-b', sectionBStudents);
        }
        
        // Update student dropdowns for records and history
        function updateStudentDropdowns() {
            const dropdown = document.getElementById('student-select');
            const historyDropdown = document.getElementById('history-student-select');
            
            // Clear existing options (except the first one)
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            while (historyDropdown.options.length > 1) {
                historyDropdown.remove(1);
            }
            
            // Add students to dropdowns
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (সেকশন ${student.section})`;
                dropdown.appendChild(option.cloneNode(true));
                historyDropdown.appendChild(option);
            });
        }
        
        // Load student records
        function loadStudentRecords() {
            const studentId = document.getElementById('student-select').value;
            const container = document.getElementById('student-records-container');
            
            if (!studentId) {
                container.style.display = 'none';
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Show container
            container.style.display = 'block';
            
            // Set student name
            document.getElementById('student-name-display').innerHTML = `<i class="fas fa-user"></i> ${student.name} (সেকশন ${student.section})`;
            
            // Calculate classes since last payment
            const lastPaymentDate = paymentRecords
                .filter(record => record.studentId === studentId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.date || student.currentCycleStart;
            
            const attendedClasses = teachingRecords.filter(record => 
                record.studentId === studentId && 
                new Date(record.date) >= new Date(lastPaymentDate)
            ).length;
            
            const progressPercent = Math.min((attendedClasses / 12) * 100, 100);
            
            // Update progress bar
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Update progress text
            document.getElementById('progress-text').textContent = `${attendedClasses}/12 দিন`;
            if (attendedClasses >= 12) {
                document.getElementById('progress-text').classList.add('completed');
            } else {
                document.getElementById('progress-text').classList.remove('completed');
            }
            
            // Load teaching records
            const studentTeachingRecords = teachingRecords
                .filter(record => record.studentId === studentId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            renderRecordsList('teaching-records', studentTeachingRecords, '<i class="fas fa-check"></i> পড়ানো হয়েছে', 'attendance-record');
            
            // Load payment records
            const studentPaymentRecords = paymentRecords
                .filter(record => record.studentId === studentId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            renderRecordsList('payment-records', studentPaymentRecords, '<i class="fas fa-check"></i> বেতন প্রদান', 'payment-record');
        }
        
        // Load cycle history for a student
        function loadCycleHistory() {
            const studentId = document.getElementById('history-student-select').value;
            const container = document.getElementById('cycle-history-container');
            
            if (!studentId) {
                container.style.display = 'none';
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Show container
            container.style.display = 'block';
            
            // Set student name
            document.getElementById('history-student-name').innerHTML = `<i class="fas fa-user"></i> ${student.name} (সেকশন ${student.section})`;
            
            // Get all payment records for this student, sorted by date (newest first)
            const studentPayments = paymentRecords
                .filter(record => record.studentId === studentId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get all teaching records for this student, sorted by date
            const studentTeachings = teachingRecords
                .filter(record => record.studentId === studentId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Prepare cycle data
            const cycles = [];
            
            // Add current cycle (not yet paid)
            cycles.push({
                startDate: student.currentCycleStart,
                endDate: null,
                paymentDate: null,
                classCount: studentTeachings
                    .filter(t => new Date(t.date) >= new Date(student.currentCycleStart))
                    .length,
                cycleType: 'current',
                teachingDates: studentTeachings
                    .filter(t => new Date(t.date) >= new Date(student.currentCycleStart))
                    .map(t => t.date)
                    .sort((a, b) => new Date(b) - new Date(a))
            });
            
            // Add previous cycles
            let nextDate = new Date().toISOString().split('T')[0];
            studentPayments.forEach((payment) => {
                cycles.push({
                    startDate: payment.date,
                    endDate: nextDate,
                    paymentDate: payment.date,
                    classCount: studentTeachings
                        .filter(t => new Date(t.date) >= new Date(payment.date) && new Date(t.date) <= new Date(nextDate))
                        .length,
                    cycleType: 'previous',
                    teachingDates: studentTeachings
                        .filter(t => new Date(t.date) >= new Date(payment.date) && new Date(t.date) <= new Date(nextDate))
                        .map(t => t.date)
                        .sort((a, b) => new Date(b) - new Date(a))
                });
                nextDate = payment.date;
            });
            
            // The earliest cycle (from registration to first payment)
            if (studentPayments.length > 0) {
                const firstPayment = studentPayments[studentPayments.length - 1];
                cycles.push({
                    startDate: student.currentCycleStart,
                    endDate: firstPayment.date,
                    paymentDate: firstPayment.date,
                    classCount: studentTeachings
                        .filter(t => new Date(t.date) >= new Date(student.currentCycleStart) && new Date(t.date) <= new Date(firstPayment.date))
                        .length,
                    cycleType: 'previous',
                    teachingDates: studentTeachings
                        .filter(t => new Date(t.date) >= new Date(student.currentCycleStart) && new Date(t.date) <= new Date(firstPayment.date))
                        .map(t => t.date)
                        .sort((a, b) => new Date(b) - new Date(a))
                });
            }
            
            // Render cycle history
            renderCycleHistory(cycles);
        }
        
        // Render cycle history
        function renderCycleHistory(cycles) {
            const container = document.getElementById('cycle-history-list');
            container.innerHTML = '';
            
            if (cycles.length === 0) {
                container.innerHTML = '<p>কোনো সাইকেল ইতিহাস পাওয়া যায়নি</p>';
                return;
            }
            
            // Sort cycles by start date (newest first)
            cycles.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            cycles.forEach((cycle, index) => {
                const cycleCard = document.createElement('div');
                cycleCard.className = 'cycle-card';
                
                const isCurrent = cycle.cycleType === 'current';
                const cycleTitle = isCurrent ? 'বর্তমান সাইকেল' : `সাইকেল ${index + 1}`;
                
                cycleCard.innerHTML = `
                    <div class="cycle-header">
                        <span>${cycleTitle}</span>
                        ${isCurrent ? '<span class="badge badge-warning">চলমান</span>' : '<span class="badge badge-success">সম্পূর্ণ</span>'}
                    </div>
                    <div class="cycle-dates">
                        <span><i class="fas fa-calendar-day"></i> শুরু: ${formatDate(cycle.startDate)}</span>
                        ${cycle.endDate ? `<span><i class="fas fa-calendar-check"></i> শেষ: ${formatDate(cycle.endDate)}</span>` : ''}
                    </div>
                    <div class="cycle-stats">
                        <div class="stat-item">
                            <div class="stat-value">${cycle.classCount}</div>
                            <div class="stat-label">মোট ক্লাস</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${cycle.paymentDate ? 'প্রদান' : 'বাকি'}</div>
                            <div class="stat-label">স্ট্যাটাস</div>
                        </div>
                        ${cycle.paymentDate ? `
                        <div class="stat-item">
                            <div class="stat-value">${formatDate(cycle.paymentDate)}</div>
                            <div class="stat-label">বেতনের তারিখ</div>
                        </div>` : ''}
                    </div>
                    <div class="toggle-dates" onclick="toggleTeachingDates(this)">
                        <i class="fas fa-calendar-alt"></i> পড়ানোর তারিখগুলো দেখুন
                    </div>
                    <div class="teaching-dates" style="display:none;">
                        ${cycle.teachingDates.map(date => `
                            <div class="teaching-date-item">
                                <span>${formatDate(date)}</span>
                                <span class="badge badge-primary">পড়ানো হয়েছে</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(cycleCard);
            });
        }
        
        // Toggle teaching dates visibility
        function toggleTeachingDates(element) {
            const datesContainer = element.nextElementSibling;
            if (datesContainer.style.display === 'none') {
                datesContainer.style.display = 'block';
                element.innerHTML = '<i class="fas fa-calendar-alt"></i> পড়ানোর তারিখগুলো লুকান';
            } else {
                datesContainer.style.display = 'none';
                element.innerHTML = '<i class="fas fa-calendar-alt"></i> পড়ানোর তারিখগুলো দেখুন';
            }
        }
        
        // Render attendance list for a section
        function renderAttendanceList(elementId, studentList) {
            const tableBody = document.getElementById(elementId).querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (studentList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5">কোনো স্টুডেন্ট রেজিস্টার্ড হয়নি</td></tr>`;
                return;
            }
            
            const currentDate = document.getElementById('record-date').value;
            const todayRecords = teachingRecords.filter(record => record.date === currentDate);
            const todayPayments = paymentRecords.filter(record => record.date === currentDate);
            
            studentList.forEach(student => {
                const lastPaymentDate = paymentRecords
                    .filter(record => record.studentId === student.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.date || student.currentCycleStart;
                
                const attendedClasses = teachingRecords.filter(record => 
                    record.studentId === student.id && 
                    new Date(record.date) >= new Date(lastPaymentDate)
                ).length;
                
                const isMarkedToday = todayRecords.some(record => record.studentId === student.id);
                const isPaidToday = todayPayments.some(record => record.studentId === student.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.phone || 'N/A'}</td>
                    <td>${attendedClasses}</td>
                    <td class="checkbox-cell"><input type="checkbox" class="teaching-check" data-id="${student.id}" ${isMarkedToday ? 'checked' : ''}></td>
                    <td class="checkbox-cell"><input type="checkbox" class="payment-check" data-id="${student.id}" ${isPaidToday ? 'checked' : ''}></td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Render all students list
        function renderAllStudentsList(elementId, studentList) {
            const tableBody = document.getElementById(elementId).querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (studentList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6">কোনো স্টুডেন্ট রেজিস্টার্ড হয়নি</td></tr>`;
                return;
            }
            
            // Sort by section
            studentList.sort((a, b) => a.section.localeCompare(b.section));
            
            studentList.forEach(student => {
                const lastPaymentDate = paymentRecords
                    .filter(record => record.studentId === student.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.date || student.currentCycleStart;
                
                const attendedClasses = teachingRecords.filter(record => 
                    record.studentId === student.id && 
                    new Date(record.date) >= new Date(lastPaymentDate)
                ).length;
                
                const paymentCount = paymentRecords.filter(record => 
                    record.studentId === student.id
                ).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>সেকশন ${student.section}</td>
                    <td>${student.name}</td>
                    <td>${student.phone || 'N/A'}</td>
                    <td>${attendedClasses}</td>
                    <td>${paymentCount} বার</td>
                    <td><button class="btn-danger btn-delete" data-id="${student.id}"><i class="fas fa-trash-alt"></i> ডিলেট</button></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteStudent(this.getAttribute('data-id'));
                });
            });
        }
        
        // Render records list
        function renderRecordsList(elementId, records, statusText, rowClass = '') {
            const tableBody = document.getElementById(elementId).querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2">কোনো রেকর্ড পাওয়া যায়নি</td></tr>`;
                return;
            }
            
            records.forEach(record => {
                const row = document.createElement('tr');
                if (rowClass) row.classList.add(rowClass);
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${statusText}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Save records
        function saveRecords() {
            const date = document.getElementById('record-date').value;
            if (!date) {
                showAlert('error', 'দয়া করে তারিখ সিলেক্ট করুন');
                return;
            }
            
            // Get all checked teaching checkboxes
            const teachingCheckboxes = document.querySelectorAll('.teaching-check:checked');
            
            // Get all checked payment checkboxes
            const paymentCheckboxes = document.querySelectorAll('.payment-check:checked');
            
            if (teachingCheckboxes.length === 0 && paymentCheckboxes.length === 0) {
                showAlert('error', 'কোনো তথ্য সিলেক্ট করা হয়নি');
                return;
            }
            
            const userId = auth.currentUser.uid;
            const updates = {};
            
            // Add teaching records for checked students
            teachingCheckboxes.forEach(checkbox => {
                const studentId = checkbox.getAttribute('data-id');
                const student = students.find(s => s.id === studentId);
                
                if (!student) return;
                
                // Check if record already exists for this student on this date
                const exists = teachingRecords.some(record => 
                    record.studentId === studentId && record.date === date
                );
                
                if (!exists) {
                    const newRecordId = database.ref('users/' + userId + '/teachingRecords').push().key;
                    updates['/users/' + userId + '/teachingRecords/' + newRecordId] = {
                        studentId: studentId,
                        date: date,
                        status: 'পড়ানো হয়েছে',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                }
            });
            
            // Add payment records for checked students
            paymentCheckboxes.forEach(checkbox => {
                const studentId = checkbox.getAttribute('data-id');
                const student = students.find(s => s.id === studentId);
                
                if (!student) return;
                
                // Check if record already exists for this student on this date
                const exists = paymentRecords.some(record => 
                    record.studentId === studentId && record.date === date
                );
                
                if (!exists) {
                    // Calculate classes since last payment
                    const lastPaymentDate = paymentRecords
                        .filter(record => record.studentId === studentId)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0]?.date || student.currentCycleStart;
                    
                    const attendedClasses = teachingRecords.filter(record => 
                        record.studentId === studentId && 
                        new Date(record.date) >= new Date(lastPaymentDate)
                    ).length;
                    
                    // Show confirmation for starting new cycle
                    let confirmMessage = `${student.name} এর জন্য নতুন সাইকেল শুরু করতে চান?`;
                    
                    if (attendedClasses < 12) {
                        confirmMessage = `${student.name} এর মাত্র ${attendedClasses} দিন পড়ানো হয়েছে (১২ দিনের কম)। তবুও নতুন সাইকেল শুরু করতে চান?`;
                    } else if (attendedClasses > 12) {
                        confirmMessage = `${student.name} এর ${attendedClasses} দিন পড়ানো হয়েছে (১২ দিনের বেশি)। তবুও নতুন সাইকেল শুরু করতে চান?`;
                    }
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    const newRecordId = database.ref('users/' + userId + '/paymentRecords').push().key;
                    updates['/users/' + userId + '/paymentRecords/' + newRecordId] = {
                        studentId: studentId,
                        date: date,
                        status: 'বেতন প্রদান করা হয়েছে',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Update student's current cycle start date
                    updates['/users/' + userId + '/students/' + studentId + '/currentCycleStart'] = date;
                }
            });
            
            // Execute all updates
            if (Object.keys(updates).length > 0) {
                database.ref().update(updates)
                    .then(() => {
                        showAlert('success', 'তথ্য সফলভাবে সেভ করা হয়েছে!');
                    })
                    .catch(error => {
                        showAlert('error', `তথ্য সেভ করতে সমস্যা: ${error.message}`);
                    });
            }
        }
        
        // Reset records for selected date
        function resetRecords() {
            const date = document.getElementById('record-date').value;
            if (!date) {
                showAlert('error', 'দয়া করে তারিখ সিলেক্ট করুন');
                return;
            }
            
            if (!confirm(`আপনি কি নিশ্চিত ${date} তারিখের সকল রেকর্ড রিসেট করতে চান?`)) {
                return;
            }
            
            const userId = auth.currentUser.uid;
            const updates = {};
            
            // Remove teaching records for selected date
            teachingRecords
                .filter(record => record.date === date)
                .forEach(record => {
                    updates['/users/' + userId + '/teachingRecords/' + record.id] = null;
                });
            
            // Remove payment records for selected date
            paymentRecords
                .filter(record => record.date === date)
                .forEach(record => {
                    updates['/users/' + userId + '/paymentRecords/' + record.id] = null;
                });
            
            // Execute all updates
            database.ref().update(updates)
                .then(() => {
                    showAlert('success', 'রেকর্ডস সফলভাবে রিসেট করা হয়েছে!');
                })
                .catch(error => {
                    showAlert('error', `রেকর্ডস রিসেট করতে সমস্যা: ${error.message}`);
                });
        }
        
        // Delete a student and all related records
        function deleteStudent(studentId) {
            if (!confirm('আপনি কি নিশ্চিত এই স্টুডেন্ট ডিলেট করতে চান? এর সাথে সাথে সকল পড়ানো ও বেতনের রেকর্ডও ডিলেট হয়ে যাবে!')) {
                return;
            }
            
            const userId = auth.currentUser.uid;
            const updates = {};
            
            // Delete student
            updates['/users/' + userId + '/students/' + studentId] = null;
            
            // Delete teaching records
            teachingRecords
                .filter(record => record.studentId === studentId)
                .forEach(record => {
                    updates['/users/' + userId + '/teachingRecords/' + record.id] = null;
                });
            
            // Delete payment records
            paymentRecords
                .filter(record => record.studentId === studentId)
                .forEach(record => {
                    updates['/users/' + userId + '/paymentRecords/' + record.id] = null;
                });
            
            // Execute all updates
            database.ref().update(updates)
                .then(() => {
                    showAlert('success', 'স্টুডেন্ট এবং সংশ্লিষ্ট সকল রেকর্ড সফলভাবে ডিলেট করা হয়েছে!');
                    
                    // Hide records if showing the deleted student
                    if (document.getElementById('records').classList.contains('active') && 
                        document.getElementById('student-select').value === studentId) {
                        document.getElementById('student-records-container').style.display = 'none';
                        document.getElementById('student-select').value = '';
                    }
                    
                    // Hide history if showing the deleted student
                    if (document.getElementById('history').classList.contains('active') && 
                        document.getElementById('history-student-select').value === studentId) {
                        document.getElementById('cycle-history-container').style.display = 'none';
                        document.getElementById('history-student-select').value = '';
                    }
                })
                .catch(error => {
                    showAlert('error', `স্টুডেন্ট ডিলেট করতে সমস্যা: ${error.message}`);
                });
        }
        
        // Delete selected student from records tab
        function deleteSelectedStudent() {
            const studentId = document.getElementById('student-select').value;
            if (!studentId) {
                showAlert('error', 'দয়া করে একটি স্টুডেন্ট সিলেক্ট করুন');
                return;
            }
            
            deleteStudent(studentId);
        }
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('bn-BD', options);
        }
    </script>
</body>
</html>
